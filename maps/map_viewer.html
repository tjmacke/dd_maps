<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>My Doordashes</title>
  <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script src="https://api.mapbox.com/mapbox.js/v2.2.2/mapbox.js"></script>
  <link href="https://api.mapbox.com/mapbox.js/v2.2.2/mapbox.css" rel="stylesheet"/>
  <style>
    body { margin: 0; padding: 0; }
    div.controls { position: absolute; width: 100%; height: 50px; top: 0; border: 2px solid black; }
    #fileReader {float: left; width: 25%; height: 100%; }

    #colorScaleBox { float: left; width: 45%; height: 100%; border: 1px solid black; }
    #colorInfo { float: left; width: 20%; height: 100%; }
    #colorScale { float: right; width: 79%; height: 100%; }

    #v2Scale { float: left; width: 29%; height: 100%; border: 1px solid black; }

    #map { position: absolute; width: 100%; height: 100%; top: 50px; border: 2px solid black; }
  </style>
</head>
<body>
  <div class="controls">
    <div id="fileReader">
      File:  <input type="file" id="fileinput" onchange="loadMapData(event)"/>
    </div>
    <div id="colorScaleBox">
      <div id="colorInfo">
        Pin Color:
      </div>
      <div id="colorScale">
<!-- this works
        <svg id="svgColorScale" height="50" width="350"/>
-->
      </div>
    </div>
    <div id="v2Scale">v2 scale goes here</div>
  </div>
  <div id="map" class="map">Map</div>
  <script type="text/javascript">
    function loadMapData(evt) {
      var f = evt.target.files[0];
  
      if (f) {
        var r = new FileReader();
        r.onload = function(e) {
          var contents = e.target.result;
          var json = JSON.parse(contents);
          makeMap(json.points);
          makeScales(json.config);
        };
        r.readAsText(f);
  
      } else {
        alert("Failed to load file");
      }
    }
    function makeScales(config) {

      // get everything parameterized.
      var cb_tick_font_size = 12;
      var cb_xoff = 5;
      var cb_width = 40;
      var cb_height = 15;
      var cb_tick_len = 5
      var cb_xHeight = Math.round(0.7 * cb_tick_font_size);
      var cb_yoff = cb_tick_font_size + 2;
      var cb_tick_yoff = cb_yoff + cb_height
      var cb_tick_text_yoff = cb_tick_yoff + cb_tick_len + cb_xHeight;

      // TODO: Add checks

      // Add the svg 
      d3.select("#colorScale")
        .append("svg")
        .attr("id", "svgColorScale")
        .attr("height", 50)
        .attr("width", config.color_values.length * cb_width + 2 * cb_xoff);

      // Draw the colored boxes
      d3.select("#svgColorScale")
        .selectAll("rect")
        .data(config.color_values)
        .enter()
        .append("rect")
        .attr("width", cb_width)
        .attr("height", cb_height)
        .attr("x", function(d, i) { return i * cb_width + cb_xoff; })
        .attr("y", cb_yoff)
        .style("fill", function(d) {
          return "rgb(" + Math.round(d[0]*255) + "," + Math.round(d[1]*255) + "," + Math.round(d[2]*255) + ")";
        })
        .style("stroke", "black")
        .style("stroke-width", "1px");

      // Draw the ticks
      d3.select("#svgColorScale")
        .selectAll("line")
        .data(config.color_breaks)
        .enter()
        .append("line")
        .attr("x1", function(d, i) { return (i+1) * cb_width + cb_xoff; })
        .attr("y1", cb_tick_yoff)
        .attr("x2", function(d, i) { return (i+1) * cb_width + cb_xoff; })
        .attr("y2", cb_yoff + cb_tick_len)
        .style("stroke", "black")
        .style("stroke-width", "1px");

      // Draw the tick labels
      d3.select("#svgColorScale")
        .selectAll("text.tick")
        .data(config.color_breaks)
        .enter()
        .append("text")
        .attr("class", "tick")
        .attr("x", function(d, i) { return (i+1) * cb_width + cb_xoff; } )
        .attr("y", cb_tick_text_yoff)
        .attr("font-size", cb_tick_font_size)
        .attr("text-anchor", "middle")
        .text(function(d) { return d; });

      // Draw the scale title
      var color_title = ("color_title" in config) ? config.color_title : ["Pin Colors"];
      d3.select("#svgColorScale")
        .selectAll("text.title")
        .data(color_title)
        .enter()
        .append("text")
        .attr("class", "title")
        .attr("x", 0.5 * (config.color_values.length * cb_width) + cb_xoff)
        .attr("y", cb_xHeight + 2)
        .attr("font-size", cb_tick_font_size)
        .attr("text-anchor", "middle")
        .text(function(d) { return d; });
    }
  </script>
  <script type="text/javascript">
    // This code sets up  the map
    L.mapbox.accessToken = "pk.eyJ1IjoidGptYWNrZSIsImEiOiJjaWZlZndqMmw2dXdycnlseHllc3hhaWxhIn0.BdoeGKCUMnGifNEsnzoOfg";
    var map = L.mapbox.map("map", "mapbox.streets").setView([37.4377, -122.1603], 14);
    var myLayer = L.mapbox.featureLayer().addTo(map);
    // This function, called by the data-is-loaded callback passed to d3.json() draws the geoJson features
    function makeMap(geoJson) {
      myLayer.setGeoJSON(geoJson);
    }
  </script>
</body>
</html>
